!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).SSEClient=t()}(this,function(){"use strict";function e(e,t=[{message:"",complete:!1}]){try{return e.reduce((e,t,n,s)=>"\n"===String.fromCharCode(t)?"\n"===String.fromCharCode(s[n+1])?(e[e.length-1].complete=!0,[...e,{message:"",complete:!1}]):e:(e[e.length-1].message=e[e.length-1].message+String.fromCharCode(s[n]),e),t)}catch(e){throw e}}function t(e){const t=[{key:"data",index:e.indexOf("data:")},{key:"event",index:e.indexOf("event:")},{key:"id",index:e.indexOf("id:")}];return t.sort((e,t)=>e.index-t.index).reduce((n,s,i)=>{const o=Object.assign({},n);return o[s.key]=t.length>i+1?e.slice(s.index+s.key.length+1,t[i+1].index):e.slice(s.index+s.key.length+1),o},{})}class n{constructor(e,t){this.readState=n.CONNECTING,this.controller=new AbortController,this.listeners=[],this.stringMessagesQueue=[],fetch(e,Object.assign({signal:this.controller.signal},t)).then(e=>{if(!e.body)throw Error("No body");this.reader=e.body.getReader(),this.start(this.reader)}).catch(e=>{throw console.error(e),e})}_onOpen(){this.readState=n.OPEN,this.onopen&&this.onopen(new Event("open"))}_onClosed(){this.readState=n.CLOSED,this.onclose&&this.onclose()}_onMessage(e){e.id&&""!==e.id&&(this.lastEventID=e.id);const t=new MessageEvent(e.event,{data:e.data,lastEventId:this.lastEventID});this.onmessage&&this.onmessage(t),this.listeners[e.event]&&this.listeners[e.event](t)}start(n){return s=this,i=void 0,r=function*(){for(;;){const{done:s,value:i}=yield n.read();if(this._onOpen(),s){this._onClosed();break}const o=this.stringMessagesQueue.filter(e=>!e.complete);this.stringMessagesQueue=e(i,o.length>0?o:void 0),this.stringMessagesQueue.filter(e=>e.complete).map(e=>t(e.message)).forEach(e=>{this._onMessage(e)})}n.releaseLock()},new((o=void 0)||(o=Promise))(function(e,t){function n(e){try{d(r.next(e))}catch(e){t(e)}}function a(e){try{d(r.throw(e))}catch(e){t(e)}}function d(t){t.done?e(t.value):new o(function(e){e(t.value)}).then(n,a)}d((r=r.apply(s,i||[])).next())});var s,i,o,r}close(){this.reader.cancel()}addEventListener(e,t){this.listeners[e]=t}removeEventListener(e){delete this.listeners[e]}}return n.CONNECTING=0,n.OPEN=1,n.CLOSED=2,n});
